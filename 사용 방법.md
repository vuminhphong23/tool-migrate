# üß≠ H∆Ø·ªöNG D·∫™N MIGRATION T·ªîNG TH·ªÇ CHO DIRECTUS

Phi√™n b·∫£n 1.0 ‚Äì D√†nh cho quy tr√¨nh di chuy·ªÉn to√†n b·ªô h·ªá th·ªëng Directus gi·ªØa hai instance (source ‚Üí target).

---
## BEFORE MIGRATION
### Y√™u c·∫ßu
C√≥ quy·ªÅn Admin (token) ·ªü c·∫£ hai Directus instance.
### Quy tr√¨nh
1. Nh·∫≠p Directus URL v√† Bearer token cho c√°c instance.
2. B·∫≠t CORS Unblock v√† test connection.
 
<img width="793" height="622" alt="image" src="https://github.com/user-attachments/assets/4b62a5c7-62bf-4a6e-966a-9d799367564b" />

3. Sau khi test connection th√†nh c√¥ng th√¨ connect to target instance
   
<img width="1212" height="745" alt="image" src="https://github.com/user-attachments/assets/ceeb2931-aedb-41fa-9d44-108ec813ec35" />
---

## ‚öôÔ∏è PH·∫¶N 1 ‚Äî SCHEMA MIGRATION

### M·ª•c ti√™u
Chuy·ªÉn to√†n b·ªô c·∫•u tr√∫c c∆° s·ªü d·ªØ li·ªáu (collections, fields, relations, validations) t·ª´ source sang target.

### Y√™u c·∫ßu
1. C√≥ quy·ªÅn Admin (token) ·ªü c·∫£ hai Directus instance.  
2. Target schema r·ªóng ho·∫∑c c·∫ßn c·∫≠p nh·∫≠t theo diff.  

### Quy tr√¨nh
1. T·∫°o **schema snapshot** t·ª´ source.

<img width="1270" height="329" alt="image" src="https://github.com/user-attachments/assets/b875958c-4449-4570-a711-2f2de59304b8" /> 

2. G·ª≠i snapshot sang target ‚Üí t·∫°o **diff**.

<img width="1440" height="729" alt="image" src="https://github.com/user-attachments/assets/d130ebe9-11d5-48ae-9039-7dd898c537dd" />

3. Ch·ªçn collections c·∫ßn migrate ‚Üí Apply Schema.

### Ch√≠nh s√°ch x·ª≠ l√Ω system collections
- **B·ªè qua** c√°c `directus_*` collections.  
- **Gi·ªØ l·∫°i** c√°c relations t·ª´ user collections ‚Üí system collections.  
- **Lo·∫°i b·ªè** relations c√≥ ngu·ªìn l√† system collections.

### Th√†nh ph·∫ßn ch√≠nh
- **Collections**: T·∫°o m·ªõi n·∫øu ch∆∞a c√≥.  
- **Fields**: T·∫°o/s·ª≠a lo·∫°i, validation, default, required.  
- **Relations**: Gi·ªØ user‚Üísystem, b·ªè system‚Üíuser.  
- **Validation Rules**: H·ªó tr·ª£ h·∫ßu h·∫øt logic `_regex`, `_in`, `_gt`, `_lte`, `_between`,...

### Th·ª© t·ª± khuy·∫øn ngh·ªã
1. Schema Migration  
2. Files (n·∫øu c√≥ `directus_files`)  
3. Data Migration  
4. Update relations b·∫±ng Data Migration (Two-Pass)

### L∆∞u √Ω quan tr·ªçng
- Kh√¥ng t·ª± ƒë·ªông x√≥a fields/relations tr√™n target.  
- C√≥ th·ªÉ ch·∫°y nhi·ªÅu l·∫ßn (idempotent).  
- ID mapping ·∫£nh h∆∞·ªüng Data Migration.
- N√™n Apply m·ªôt l·∫ßn √≠t h∆°n 15 collection ƒë·ªÉ tr√°nh qu√° t·∫£i.

---

## üíæ PH·∫¶N 2 ‚Äî DATA MIGRATION

### M·ª•c ti√™u
Di chuy·ªÉn d·ªØ li·ªáu gi·ªØa hai instances sau khi schema ƒë√£ kh·ªõp.

### Y√™u c·∫ßu
- Target ƒë√£ c√≥ schema (status ‚ÄúExisting‚Äù).

<img width="2880" height="1196" alt="anh1" src="https://github.com/user-attachments/assets/9be040ca-a339-4fe2-adaa-1b52d29e10d3" />

### Selective Import
1. Ch·ªçn collection ‚Üí b·∫•m **Select Items**.  
2. Tick c√°c items c·∫ßn import.  
3. (Tu·ª≥ ch·ªçn) ch·ªçn fields mu·ªën migrate.  
4. B·∫•m **Import Selected**.

K·∫øt qu·∫£: Tool ch·ªâ import c√°c item/field ƒë√£ ch·ªçn, c√≥ ti·∫øn tr√¨nh chi ti·∫øt.

---

### Field Selection ‚Äì Two-Pass Migration
D√πng khi collection c√≥ **foreign keys**.

#### **B∆∞·ªõc 1:** Import Regular Fields
- Ch·ªâ ch·ªçn fields c∆° b·∫£n (`title`, `description`, ‚Ä¶).  
- B·ªè c√°c relation fields (`_id`, `author_id`, ‚Ä¶).  

#### **B∆∞·ªõc 2:** Update Relation Fields
- Sau khi collections li√™n quan ƒë√£ c√≥ data, import l·∫°i.  
- Ch·ªâ ch·ªçn relation fields ƒë·ªÉ update.

‚úÖ Gi·ªØ nguy√™n ID g·ªëc.  
‚úÖ Kh√¥ng l·ªói constraint.  
‚úÖ D·ªØ li·ªáu ho√†n ch·ªânh sau 2 pass.

---

### Workflow v√≠ d·ª•
```
Microsite_Article
```
- Pass 1: Import regular fields.

<img width="2880" height="1196" alt="anh2" src="https://github.com/user-attachments/assets/95bd6b25-70bd-46ec-a656-e5e9fd17b356" />

<img width="2880" height="1292" alt="anh3" src="https://github.com/user-attachments/assets/64c06ccc-385c-44c8-81e7-dcc242c5157d" />

<img width="2880" height="1310" alt="anh4" src="https://github.com/user-attachments/assets/efd1f050-0eb6-4803-999d-04f158a91e08" />


- Pass 2: Update relation fields (`division`, `image_src`, `title`...).

<img width="2880" height="1292" alt="anh5" src="https://github.com/user-attachments/assets/c846bb30-4d32-410c-a5fd-9d6e3d2b5106" />

<img width="2880" height="1310" alt="anh6" src="https://github.com/user-attachments/assets/e1841d86-adcf-4397-a190-0aa52c8dd662" />

---

### Troubleshooting
- **Collection ch∆∞a t·ªìn t·∫°i:** ch·∫°y Schema Migration tr∆∞·ªõc.  
- **L·ªói 403/400:** d√πng Two-Pass.  
- **Kh√¥ng update:** ki·ªÉm tra ID format.  
- **Relation kh√¥ng c·∫≠p nh·∫≠t:** qu√™n ch·∫°y Pass 2.  

---

### API tham chi·∫øu
- `previewCollectionItems()`  
- `importSelectedItems()`  
- `importFromDirectus()`

---

## üîê PH·∫¶N 3 ‚Äî ACCESS CONTROL & FLOWS
 
---

### 3.1 ‚Äî Access Control Migration (Roles, Policies, Permissions, User Assignments)

#### M·ª•c ti√™u

ƒê·∫£m b·∫£o c√°c Roles, Policies, Permissions v√† User Assignments ƒë∆∞·ª£c migrate ch√≠nh x√°c, an to√†n, gi·ªØ nguy√™n logic ph√¢n quy·ªÅn.

#### Th√†nh ph·∫ßn ch√≠nh

| Collection              | M√¥ t·∫£                                 | Ph·ª• thu·ªôc |
| ----------------------- | ------------------------------------- | --------- |
| `directus_roles`        | Nh√≥m ng∆∞·ªùi d√πng                       | none      |
| `directus_policies`     | T·∫≠p h·ª£p quy t·∫Øc quy·ªÅn h·∫°n             | none      |
| `directus_permissions`  | Quy·ªÅn chi ti·∫øt theo collection/action | policies  |
| `user_role_assignments` | G√°n role cho user                     | roles     |

#### Th·ª© t·ª± migrate khuy·∫øn ngh·ªã

1. Roles ‚Üí 2) Policies ‚Üí 3) Permissions ‚Üí 4) User Assignments

#### C√°c b∆∞·ªõc thao t√°c (UI)

- Ch·ªçn Access Control Migration

<img width="1440" height="560" alt="Screenshot 2025-11-10 at 16 54 26" src="https://github.com/user-attachments/assets/1301861e-786c-4d3c-a793-299bfcd879e6" />

- Ch·ªçn item mu·ªën migrate v√† ·∫•n Migrate Selected

<img width="1440" height="650" alt="Screenshot 2025-11-10 at 16 58 04" src="https://github.com/user-attachments/assets/adc5e3cc-47ea-4732-bf79-b796e1398956" />

- Theo d√µi log

<img width="1440" height="645" alt="Screenshot 2025-11-10 at 16 59 07" src="https://github.com/user-attachments/assets/e87faada-4b11-41dc-a8ad-368dd20c95df" />

#### Chi·∫øn l∆∞·ª£c/logic √°p d·ª•ng

- Role: preserve ID khi c√≥ th·ªÉ, skip c√°c admin roles theo c√†i ƒë·∫∑t an to√†n.
- Policy: validate ‚Äì map l·∫°i collections/fields n·∫øu t√™n kh√°c nhau gi·ªØa m√¥i tr∆∞·ªùng.
- Permission: validate rule JSON, skip invalid, transform mapping cho ph√π h·ª£p schema target.
- User assignments: ch·ªâ ch·∫°y sau khi roles/policies ƒë√£ t·ªìn t·∫°i tr√™n target.

#### Ki·ªÉm tra b·∫£o m·∫≠t

- So s√°nh thay ƒë·ªïi quy·ªÅn admin.
- G·∫Øn nh√£n r·ªßi ro: `over_permissive`, `under_permissive`, `admin_access`.
- Xu·∫•t log chi ti·∫øt ƒë·ªÉ review tr∆∞·ªõc khi apply tr√™n production.

#### L∆∞u √Ω

- ‚ùå Kh√¥ng migrate admin roles n·∫øu kh√¥ng ƒë∆∞·ª£c ph√©p.
- ‚úÖ Gi·ªØ nguy√™n ID mapping gi·ªØa roles/policies/permissions.
- ‚ö†Ô∏è Validate collection/field t·ªìn t·∫°i tr√™n target.
- üß© Test tr√™n staging tr∆∞·ªõc production.
- üß∞ Backup target tr∆∞·ªõc khi apply.

---

### 3.2 ‚Äî Flow Migration (Automation Flows)

#### M·ª•c ti√™u

Di chuy·ªÉn c√°c Flows (triggers, operations, schedules) gi·ªØa hai m√¥i tr∆∞·ªùng v√† b·∫£o to√†n h√†nh vi.

#### N·ªôi dung bao g·ªìm

- Flows, Triggers (event/webhook/schedule), Operations, Env bindings.
- Tham chi·∫øu t·ªõi collections/fields/permissions li√™n quan.

#### C√°c b∆∞·ªõc thao t√°c (UI)

- Ch·ªçn Flows & Operations Migration

<img width="1440" height="560" alt="Screenshot 2025-11-10 at 16 54 26" src="https://github.com/user-attachments/assets/5624a8c0-4f14-48ab-a61f-1010284e2f7a" />

- Ch·ªçn Flow mu·ªën migrate v√† ch·ªçn Migrate Flow

<img width="1439" height="648" alt="Screenshot 2025-11-10 at 17 03 25" src="https://github.com/user-attachments/assets/490b136f-8430-47d6-962b-47df838edaf4" />

<img width="1440" height="646" alt="Screenshot 2025-11-10 at 17 03 41" src="https://github.com/user-attachments/assets/7029c023-8e98-4286-9c21-49c6d9101852" />

- Theo d√µi log

<img width="1440" height="656" alt="Screenshot 2025-11-10 at 17 03 55" src="https://github.com/user-attachments/assets/7e66f5a1-3819-4805-93b2-e092e4617450" />

#### L∆∞u √Ω khi migrate Flows

- C·∫≠p nh·∫≠t URLs (webhook/callback) theo m√¥i tr∆∞·ªùng target.  
  +- Ki·ªÉm tra env vars (keys/secrets) ‚Äì thay b·∫±ng bi·∫øn t∆∞∆°ng ·ª©ng tr√™n target.  
  +- ƒê·∫£m b·∫£o permissions c·∫ßn thi·∫øt ƒë√£ c√≥ (n√™n ch·∫°y 3.1 tr∆∞·ªõc).  
  +- Test th·ªß c√¥ng c√°c triggers quan tr·ªçng sau khi migrate.

---

## üöÄ T·ªîNG K·∫æT QUY TR√åNH MIGRATION

| B∆∞·ªõc                                 | N·ªôi dung ch√≠nh                               | M·ª•c ti√™u                               |
| ------------------------------------ | -------------------------------------------- | -------------------------------------- |
| **1. Schema Migration**              | T·∫°o c·∫•u tr√∫c, collections, fields, relations | Chu·∫©n b·ªã khung h·ªá th·ªëng                |
| **2. Data Migration**                | Import d·ªØ li·ªáu th·ª±c t·∫ø (Two-Pass)            | L√†m ƒë·∫ßy n·ªôi dung                       |
| **3. Roles & Permissions Migration** | Chuy·ªÉn quy·ªÅn, ch√≠nh s√°ch, flows              | Gi·ªØ nguy√™n ph√¢n quy·ªÅn & logic v·∫≠n h√†nh |