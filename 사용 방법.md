# üß≠ H∆Ø·ªöNG D·∫™N MIGRATION T·ªîNG TH·ªÇ CHO DIRECTUS

Phi√™n b·∫£n 1.0 ‚Äì D√†nh cho quy tr√¨nh di chuy·ªÉn to√†n b·ªô h·ªá th·ªëng Directus gi·ªØa hai instance (source ‚Üí target).

---

## ‚öôÔ∏è PH·∫¶N 1 ‚Äî SCHEMA MIGRATION

### M·ª•c ti√™u
Chuy·ªÉn to√†n b·ªô c·∫•u tr√∫c c∆° s·ªü d·ªØ li·ªáu (collections, fields, relations, validations) t·ª´ source sang target.

### Y√™u c·∫ßu
1. C√≥ quy·ªÅn Admin (token) ·ªü c·∫£ hai Directus instance.  
2. Target schema r·ªóng ho·∫∑c c·∫ßn c·∫≠p nh·∫≠t theo diff.  
3. N√™n backup target tr∆∞·ªõc khi apply.

### Quy tr√¨nh
1. T·∫°o **schema snapshot** t·ª´ source.  
2. G·ª≠i snapshot sang target ‚Üí t·∫°o **diff**.  
3. Ch·ªçn collections c·∫ßn migrate ‚Üí Apply Schema.

### Ch√≠nh s√°ch x·ª≠ l√Ω system collections
- **B·ªè qua** c√°c `directus_*` collections.  
- **Gi·ªØ l·∫°i** c√°c relations t·ª´ user collections ‚Üí system collections.  
- **Lo·∫°i b·ªè** relations c√≥ ngu·ªìn l√† system collections.

### Tr√™n giao di·ªán tool
1. V√†o **Schema Migration**.  
2. Nh·∫≠p URL & token c·ªßa source v√† target.  
3. B·∫•m **Scan Schema**.  
4. Ch·ªçn collections.  
5. B·∫•m **Apply Schema**.

### Th√†nh ph·∫ßn ch√≠nh
- **Collections**: T·∫°o m·ªõi n·∫øu ch∆∞a c√≥.  
- **Fields**: T·∫°o/s·ª≠a lo·∫°i, validation, default, required.  
- **Relations**: Gi·ªØ user‚Üísystem, b·ªè system‚Üíuser.  
- **Validation Rules**: H·ªó tr·ª£ h·∫ßu h·∫øt logic `_regex`, `_in`, `_gt`, `_lte`, `_between`,...

### Th·ª© t·ª± khuy·∫øn ngh·ªã
1. Schema Migration  
2. Files (n·∫øu c√≥ `directus_files`)  
3. Data Migration  
4. Update relations b·∫±ng Data Migration (Two-Pass)

### L∆∞u √Ω quan tr·ªçng
- Kh√¥ng t·ª± ƒë·ªông x√≥a fields/relations tr√™n target.  
- C√≥ th·ªÉ ch·∫°y nhi·ªÅu l·∫ßn (idempotent).  
- ID mapping ·∫£nh h∆∞·ªüng Data Migration.

---

## üíæ PH·∫¶N 2 ‚Äî DATA MIGRATION

### M·ª•c ti√™u
Di chuy·ªÉn d·ªØ li·ªáu gi·ªØa hai instances sau khi schema ƒë√£ kh·ªõp.

### Y√™u c·∫ßu
- Target ƒë√£ c√≥ schema (status ‚ÄúExisting‚Äù).  
- C√≥ quy·ªÅn Read (source), Create/Update (target).  

### Selective Import
1. Ch·ªçn collection ‚Üí b·∫•m **Select Items**.  
2. Tick c√°c items c·∫ßn import.  
3. (Tu·ª≥ ch·ªçn) ch·ªçn fields mu·ªën migrate.  
4. B·∫•m **Import Selected**.

K·∫øt qu·∫£: Tool ch·ªâ import c√°c item/field ƒë√£ ch·ªçn, c√≥ ti·∫øn tr√¨nh chi ti·∫øt.

---

### Field Selection ‚Äì Two-Pass Migration
D√πng khi collection c√≥ **foreign keys**.

#### **B∆∞·ªõc 1:** Import Regular Fields
- Ch·ªâ ch·ªçn fields c∆° b·∫£n (`title`, `description`, ‚Ä¶).  
- B·ªè c√°c relation fields (`_id`, `author_id`, ‚Ä¶).  

#### **B∆∞·ªõc 2:** Update Relation Fields
- Sau khi collections li√™n quan ƒë√£ c√≥ data, import l·∫°i.  
- Ch·ªâ ch·ªçn relation fields ƒë·ªÉ update.

‚úÖ Gi·ªØ nguy√™n ID g·ªëc.  
‚úÖ Kh√¥ng l·ªói constraint.  
‚úÖ D·ªØ li·ªáu ho√†n ch·ªânh sau 2 pass.

---

### Workflow v√≠ d·ª•
```
categories ‚Üí authors ‚Üí posts ‚Üí comments
```
- Pass 1: Import regular fields.
- Pass 2: Update relation fields (`category_id`, `author_id`, `post_id`...).

---

### Troubleshooting
- **Collection ch∆∞a t·ªìn t·∫°i:** ch·∫°y Schema Migration tr∆∞·ªõc.  
- **L·ªói 403/400:** d√πng Two-Pass.  
- **Kh√¥ng update:** ki·ªÉm tra ID format.  
- **Relation kh√¥ng c·∫≠p nh·∫≠t:** qu√™n ch·∫°y Pass 2.  

---

### API tham chi·∫øu
- `previewCollectionItems()`  
- `importSelectedItems()`  
- `importFromDirectus()`

---

## üîê PH·∫¶N 3 ‚Äî ROLE, PERMISSION & FLOW MIGRATION

### M·ª•c ti√™u
ƒê·∫£m b·∫£o c√°c **Roles**, **Policies**, **Permissions**, v√† **User Assignments** ƒë∆∞·ª£c migrate ch√≠nh x√°c v√† an to√†n.

### Th√†nh ph·∫ßn ch√≠nh
| Collection | M√¥ t·∫£ | Ph·ª• thu·ªôc |
|-------------|--------|------------|
| `directus_roles` | Nh√≥m ng∆∞·ªùi d√πng | none |
| `directus_policies` | T·∫≠p h·ª£p quy t·∫Øc quy·ªÅn h·∫°n | none |
| `directus_permissions` | Quy·ªÅn chi ti·∫øt theo collection/action | policies |
| `user_role_assignments` | G√°n role cho user | roles |

---

### Th·ª© t·ª± migrate
1. **Roles** ‚Üí kh√¥ng c√≥ dependency  
2. **Policies** ‚Üí kh√¥ng c√≥ dependency  
3. **Permissions** ‚Üí ph·ª• thu·ªôc v√†o Policies  
4. **User Assignments / Flow** ‚Üí sau khi Roles ƒë√£ c√≥  

---

### Th√°ch th·ª©c th∆∞·ªùng g·∫∑p
- Mapping ID gi·ªØa Policies v√† Permissions.  
- Kh√°c bi·ªát t√™n collection, field gi·ªØa m√¥i tr∆∞·ªùng.  
- R·ªßi ro b·∫£o m·∫≠t (qu√° quy·ªÅn / thi·∫øu quy·ªÅn).  
- C·∫•u tr√∫c rule JSON ph·ª©c t·∫°p.

---

### Chi·∫øn l∆∞·ª£c tri·ªÉn khai

#### **1. Ph√¢n t√≠ch & ki·ªÉm tra**
- ƒê·∫øm v√† ph√¢n lo·∫°i roles, policies, permissions.  
- Ki·ªÉm tra collections/fields t·ªìn t·∫°i tr√™n target.  
- Ph√°t hi·ªán xung ƒë·ªôt, r·ªßi ro b·∫£o m·∫≠t.

#### **2. Logic migrate th√¥ng minh**
- RoleMigration: preserve ID, skip admin roles, x·ª≠ l√Ω conflict.  
- PolicyMigration: validate, mapping collections/fields.  
- PermissionMigration: validate rules, skip invalid, transform mapping.

#### **3. Ki·ªÉm tra b·∫£o m·∫≠t**
- ƒê√°nh gi√° c√°c thay ƒë·ªïi quy·ªÅn admin.  
- So s√°nh new vs removed permissions.  
- G·∫Øn nh√£n risk: `over_permissive`, `under_permissive`, `admin_access`.

#### **4. T√≠ch h·ª£p giao di·ªán**
- Giao di·ªán ch·ªçn roles/policies/permissions.  
- Xem tr∆∞·ªõc diff tr∆∞·ªõc khi apply.  
- Theo d√µi progress & logging chi ti·∫øt.

---

### L∆∞u √Ω quan tr·ªçng
- ‚ùå Kh√¥ng migrate admin roles n·∫øu kh√¥ng ƒë∆∞·ª£c ph√©p.  
- ‚úÖ Gi·ªØ nguy√™n ID mapping gi·ªØa roles/policies/permissions.  
- ‚ö†Ô∏è Validate field v√† collection t·ªìn t·∫°i tr√™n target.  
- üß© Test tr√™n m√¥i tr∆∞·ªùng staging tr∆∞·ªõc production.  
- üß∞ Backup target tr∆∞·ªõc khi apply.

---

### Ngu·ªìn tham kh·∫£o
- [Directus Docs](https://docs.directus.io/user-guide/user-management/)  
- [Directus SDK & API Reference](https://docs.directus.io/reference/system/roles/)  
- [Directus Template CLI](https://www.npmjs.com/package/directus-template-cli)

---

## üöÄ T·ªîNG K·∫æT QUY TR√åNH MIGRATION

| B∆∞·ªõc | N·ªôi dung ch√≠nh | M·ª•c ti√™u |
|------|----------------|----------|
| **1. Schema Migration** | T·∫°o c·∫•u tr√∫c, collections, fields, relations | Chu·∫©n b·ªã khung h·ªá th·ªëng |
| **2. Data Migration** | Import d·ªØ li·ªáu th·ª±c t·∫ø (Two-Pass) | L√†m ƒë·∫ßy n·ªôi dung |
| **3. Roles & Permissions Migration** | Chuy·ªÉn quy·ªÅn, ch√≠nh s√°ch, flows | Gi·ªØ nguy√™n ph√¢n quy·ªÅn & logic v·∫≠n h√†nh |
